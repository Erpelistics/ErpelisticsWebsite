{{/*
  get-gallery.html
  Returns a dict with gallery info for a given page object.
  Works for albums and sub-albums.
*/}}

{{ $page := . }} {{/* page object passed from album-card.html */}}
{{ $gallery := dict }}
{{ $images := slice }}
{{ $videos := slice }}

{{/* --- Collect images --- */}}
{{ range $image := where ($page.Resources.ByType "image") "Params.hidden" "ne" true }}
  {{ $title := "" }}
  {{ $date := "" }}

  {{ with $image.Exif }}
    {{ $date = .Date }}
    {{ with .Tags.ImageDescription }}
      {{ $title = . }}
    {{ end }}
  {{ end }}

  {{ if ne $image.Title $image.Name }}
    {{ $title = $image.Title }}
  {{ end }}

  {{ if $image.Params.Date }}
    {{ $date = time $image.Params.Date }}
  {{ end }}

  {{ $images = $images | append (dict
    "Name" $image.Name
    "Title" $title
    "Date" $date
    "Credit" $image.Params.credit
    "image" $image
    "Params" $image.Params
  )}}
{{ end }}

{{/* --- Collect videos (image resources with video_link param) --- */}}
{{ range $video := where ($page.Resources.ByType "image") "Params.video_link" "ne" nil }}
  {{ $videos = $videos | append (dict
    "Name" $video.Name
    "Title" $video.Params.title
    "Credit" $video.Params.credit
    "VideoLink" $video.Params.video_link
    "Thumb" $video
  )}}
{{ end }}

{{/* --- Determine featured image safely --- */}}
{{ if ge (len $images) 1 }}
  {{ $covers := where ($page.Resources.ByType "image") "Params.cover" "eq" true }}
  {{ $cover := "" }}
  {{ if ge (len $covers) 1 }}
    {{ $cover = index $covers 0 }}
  {{ end }}

  {{ $featuredResource := $cover | default (($page.Resources.ByType "image").GetMatch ($page.Params.featured_image | default "*feature*")) | default ((index $images 0).image) }}
  {{ $thumbnail := $featuredResource.Filter (slice images.AutoOrient (images.Process "fit 600x600")) }}
  {{ $color := index $thumbnail.Colors 0 | default "transparent" }}

  {{ $imageCount := len $images }}
  {{ $albumCount := 0 }}

  {{ if not $page.IsPage }}
    {{ range where $page.RegularPagesRecursive "Params.private" "ne" true }}
      {{ $albumCount = add $albumCount 1 }}
      {{ $imageCount = add $imageCount (len (where (.Resources.ByType "image") "Params.hidden" "ne" true)) }}
    {{ end }}
  {{ end }}

  {{ $gallery = dict
    "page" $page
    "images" $images
    "videos" $videos
    "thumbnail" $thumbnail
    "color" $color
    "albumCount" $albumCount
    "imageCount" $imageCount
    "subtitle" $page.Params.subtitle
  }}
{{ end }}

{{ return $gallery }}
